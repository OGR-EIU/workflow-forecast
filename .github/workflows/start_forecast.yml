name: Prepare local forecast package

permissions:
  actions: write

on:
  workflow_dispatch:
    inputs:
      model_repo:
         description: "Country model repo"
         required: true
         type: choice
         options:
           - "Model-US"
           - "Model-EA"
           - "Model-CZ"
      model_repo_ref:
          description: "Country model version"
          required: false
          type: string
          default: ""

jobs:

  identify_model_repo:
    runs-on: ubuntu-latest
    outputs:
      SHA: ${{ steps.model_repo.outputs.SHA }}
    steps:
      - name: Clone country model repo
        uses: actions/checkout@v3
        with:
          repository: OGR-EIU/${{ inputs.model_repo }}
          ref: ${{ inputs.model_repo_ref }}
          fetch-depth: 1
          path: ./${{ inputs.model_repo }}
          token: ${{ secrets.token_with_all_access }}

      - name: Get SHA of model repo
        id: model_repo
        run: |
          cd $GITHUB_WORKSPACE/${{ inputs.model_repo }}
          SHA="$(git rev-parse --short HEAD)"
          echo *************************************
          pwd
          git status
          echo $SHA          
          echo "SHA=$SHA" >> $GITHUB_OUTPUT
          cd $GITHUB_WORKSPACE


  create_local_environment:
    needs: identify_model_repo
    runs-on: ubuntu-latest
    env:
      CI_AUTHOR: Production workflow
      CI_EMAIL: "noreply@ogresearch.com"
      
    steps:
      - name: Clone workflow repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          path: "./workflow-forecast"
          token: ${{ secrets.token_with_all_access }}

      - name: Clone country model repo
        uses: actions/checkout@v3
        with:
          repository: OGR-EIU/${{ inputs.model_repo }}
          ref: ${{ inputs.model_repo_ref }}
          fetch-depth: 1
          path: ./${{ inputs.model_repo }}
          token: ${{ secrets.token_with_all_access }}

      - name: Config workflow-forecast and get SHA
        id: workflow_forecast_repo
        env:
          MODEL_REPO_SHA: ${{ needs.identify_model_repo.outputs.SHA }}
          XXX: 1
        run: |
          cd $GITHUB_WORKSPACE/workflow-forecast
          git config user.name "${{ env.CI_AUTHOR }}"
          git config user.email "${{ env.CI_EMAIL }}"
          SHA="$(git rev-parse --short HEAD)"
          echo *************************************
          echo $MODEL_REPO_SHA
          echo $XXX
          pwd
          git status
          echo $SHA
          echo "SHA=$SHA" >> $GITHUB_OUTPUT
          cd $GITHUB_WORKSPACE

      - name: Get SHA of model repo
        id: model_repo
        run: |
          cd $GITHUB_WORKSPACE/${{ inputs.model_repo }}
          SHA="$(git rev-parse --short HEAD)"
          echo *************************************
          pwd
          git status
          echo $SHA          
          echo "SHA=$SHA" >> $GITHUB_OUTPUT
          cd $GITHUB_WORKSPACE

      - name: Create timestamp, branch name and the MAIN forecast branch
        id: forecast_branch
        run: |
          cd $GITHUB_WORKSPACE/workflow-forecast
          timestamp="$(date -uIseconds)U"
          forecast_branch_name="forecast-${{ inputs.model_repo }}-$timestamp"
          forecast_branch_name="${forecast_branch_name//:/-}"
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
          echo "forecast_branch_name=$forecast_branch_name" >> $GITHUB_OUTPUT
          git switch -c "$forecast_branch_name-MAIN"
          cd $GITHUB_WORKSPACE

      - name: Populate script with input parameters
        run: |
          cd $GITHUB_WORKSPACE/workflow-forecast
          cp ./.github/workflows/prepare_local_environment.py ./analyst/prepare_local_environment.py
          sed -i "s/@(workflow_forecast_repo)/workflow_forecast/g" ./analyst/prepare_local_environment.py
          sed -i "s/@(workflow_forecast_repo_sha)/${{ steps.workflow_forecast_repo.outputs.SHA }}/g" ./analyst/prepare_local_environment.py
          sed -i "s/@(model_repo)/${{ inputs.model_repo }}/g" ./analyst/prepare_local_environment.py
          sed -i "s/@(model_repo_sha)/${{ steps.model_repo.outputs.SHA }}/g" ./analyst/prepare_local_environment.py
          cd $GITHUB_WORKSPACE

      - name: Commit the MAIN forecast branch
        run: |
          cd $GITHUB_WORKSPACE/workflow-forecast
          forecast_branch_name=${{ steps.forecast_branch.outputs.forecast_branch_name }}
          echo "${{ steps.forecast_branch.outputs.forecast_branch_name }}" > ./analyst/forecast_branch_name
          echo "${{ steps.forecast_branch.outputs.timestamp }}" > ./analyst/timestamp
          echo "${{ steps.workflow_forecast_repo.outputs.SHA }}" > ./analyst/workflow_forecast_repo_sha
          echo "${{ steps.model_repo.outputs.SHA }}" > ./analyst/model_repo_sha
          git add ./analyst/
          git commit -m "Prepared $forecast_branch_name-MAIN"
          git push origin "$forecast_branch_name-MAIN"
          cd $GITHUB_WORKSPACE

      - name: Create and commit the ANALYST forecast branch
        run: |
          cd $GITHUB_WORKSPACE/workflow-forecast
          forecast_branch_name=${{ steps.forecast_branch.outputs.forecast_branch_name }}
          git switch -c "$forecast_branch_name-ANALYST"
          git push origin "$forecast_branch_name-ANALYST"
          cd $GITHUB_WORKSPACE


